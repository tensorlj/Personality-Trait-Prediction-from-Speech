# -*- coding: utf-8 -*-
"""app

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1HBsnidq9yioWtqD3eucWsXBc6S2hIgid
"""

#!pip install -q git+https://github.com/openai/whisper.git

#pip install streamlit

import streamlit as st
import whisper
import joblib
from sentence_transformers import SentenceTransformer
import soundfile as sf
import numpy as np
import tempfile
import os

@st.cache_resource
def load_models():
    st.info("Loading models, please wait...")
    whisper_model = whisper.load_model("medium")
    embedding_model = SentenceTransformer('paraphrase-multilingual-MiniLM-L12-v2')
    classifier = joblib.load('classifier.joblib')
    st.success("Models loaded successfully!")
    return whisper_model, embedding_model, classifier

whisper_model, embedding_model, classifier = load_models()

# --- Streamlit App UI ---
st.title("üó£Ô∏è Personality Trait Audio Classifier")
st.write("""
Upload an audio file (in Hindi/Hinglish) and the app will predict
whether the speaker's personality is 'GHOT' or 'ACADS LITE'.
""")

uploaded_file = st.file_uploader("Choose an audio file...", type=["wav", "mp3", "m4a"])

if uploaded_file is not None:
    st.audio(uploaded_file, format='audio/wav')

    with st.spinner('Analyzing audio... Please wait.'):
        # Create a temporary file to save the uploaded content
        with tempfile.NamedTemporaryFile(delete=False, suffix='.m4a') as tmp_file:
            tmp_file.write(uploaded_file.getvalue())
            temp_filename = tmp_file.name

        st.write("Step 1: Transcribing audio to text...")
        transcription_result = whisper_model.transcribe(temp_filename, task='translate', language='hi')
        transcribed_text = transcription_result['text']

        os.remove(temp_filename)

        st.info(f"**Transcription:** \"{transcribed_text}\"")

        # --- The rest of your pipeline remains the same ---
        st.write("Step 2: Creating text embedding...")
        embedding = embedding_model.encode([transcribed_text])

        st.write("Step 3: Predicting personality trait...")
        prediction = classifier.predict(embedding)

    # --- Display Result ---
    st.success("Analysis Complete!")

    final_prediction = prediction[0]
    st.metric(label="Predicted Personality Trait", value=final_prediction)